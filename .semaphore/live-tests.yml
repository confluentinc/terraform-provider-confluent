version: v1.0
name: Live Integration Tests for Confluent Provider
agent:
  machine:
    type: s1-prod-ubuntu24-04-amd64-2

auto_cancel:
  running:
    when: "false"

global_job_config:
  prologue:
    commands:
      - sem-version go 1.24.4
      - export "GOPATH=$(go env GOPATH)"
      - >-
        export
        "SEMAPHORE_GIT_DIR=${GOPATH}/src/github.com/confluentinc/${SEMAPHORE_PROJECT_NAME}"
      - 'export "PATH=${GOPATH}/bin:${PATH}"'
      - 'mkdir -vp "${SEMAPHORE_GIT_DIR}" "${GOPATH}/bin"'
      - checkout

execution_time_limit:
  hours: 8

blocks:
  - name: "Live Integration Tests"
    task:
      jobs:
        - name: "Run Live Tests"
          commands:
            - . vault-sem-get-secret v1/ci/kv/apif/terraform-provider-confluent/live-testing-data
            - |
              # Map parameter values to make commands
              case "$TF_LIVE_TEST_GROUPS" in
                "all"|"")
                  echo "Running ALL live tests..."
                  make live-test
                  ;;
                "core")
                  echo "Running CORE live tests..."
                  make live-test GROUPS="core"
                  ;;
                "kafka")
                  echo "Running KAFKA live tests..."
                  make live-test GROUPS="kafka"
                  ;;
                "essential")
                  echo "Running ESSENTIAL live tests (Core + Kafka)..."
                  make live-test GROUPS="core,kafka"
                  ;;
                "connect")
                  echo "Running CONNECT live tests..."
                  make live-test GROUPS="connect"
                  ;;
                "schema_registry")
                  echo "Running SCHEMA REGISTRY live tests..."
                  make live-test GROUPS="schema_registry"
                  ;;
                "networking")
                  echo "Running NETWORKING live tests..."
                  make live-test GROUPS="networking"
                  ;;
                "flink")
                  echo "Running FLINK live tests..."
                  make live-test GROUPS="flink"
                  ;;
                "rbac")
                  echo "Running RBAC live tests..."
                  make live-test GROUPS="rbac"
                  ;;
                "data_catalog")
                  echo "Running DATA CATALOG live tests..."
                  make live-test GROUPS="data_catalog"
                  ;;
                "tableflow")
                  echo "Running TABLEFLOW live tests..."
                  make live-test GROUPS="tableflow"
                  ;;
                *)
                  echo "Unknown TF_LIVE_TEST_GROUPS value: '$TF_LIVE_TEST_GROUPS'"
                  echo "Valid options: all, core, kafka, essential, connect, schema_registry, networking, flink, rbac, data_catalog, tableflow"
                  echo "Defaulting to ALL tests..."
                  make live-test
                  ;;
              esac 